# 6分库分表

## 1、从单机到集群

### 容量有限，难以扩容

### 读写压力，QPS过大，特别是分析类（OLAP）需求会影响到业务需求（OLTP）

### 可用性不足，宕机问题

## 2、mysql主从复制

### 原理

- 核心：
主库写binlog
从库relay log

	- 

- binlog格式

	- ROW

		- 数据本身
		- 日志量大

	- Statement

		- SQL语句本身

			- 没有select，只有更新等影响表数据、结构的

		- 数据量比较小

	- Mixed

- binlog查看

	- mysqlbinlog命令
	- mysql-bin.0000x文件

- 传统主从复制

	- 
	- 都是异步的，可能数据不一致

- 半同步复制

	- 
	- 需要启用插件
	- 保证至少有一个能跟上主库

- MGR：MySQL Group Replication
组复制

	- 
	- 也修改了一致性，可以参考预习资料

		- 黑魔法

			- create table t2 like t1;
			- create database xxx和create schema xxx是一样的

				- catalog, schema, database

					- postgresql比较标准，因为有schema等

			- show plugins; 显示插件

### 局限性

- 主从延迟问题
- 应用侧需要配合读写分离框架
- 不解决高可用问题

	- 主从复制不可以，但MGR可以，MGR除了主从，还做了高可用

### 常见高可用架构

### 数据库分库分表

### 分布式事务

## 3、mysql读写分离

### 读写分离在业务系统里的应用

- 配置多个数据源，实现读写分离
- proxy的方式

	- 支持异构，不管是否java都可以用

- ss中

	- 用sharding-jdbc方式的可能比较多

		- 一部分是因为决策层级的因素，sharding-jdbc直接开发就可以，sharding-proxy需要有新的服务器，需要DBA、领导支持

	- 分布式数据库可能更考据

		- 决策层级更高
		- 大家要重头开始、学习成本、系统成本等

### 主从同步延迟的问题

- 常见业务逻辑，一般延迟要求不高，几毫秒基本影响不大，
- shardingjdbc支持从库失败转移到主库，也支持线上支持

## 4、mysql高可用

### 高可用的定义

- 高可用意味着，更少的不可服务时间。一般用SLA/SLO衡量
- 常规讨论的是99.9（8.76小时）、99.99（52.6分钟）

	- 99太容易达到，没意义：87.6小时
	- 99.999：5.26分钟，太难，99.999%以上系统用不到，也不可能
	- 一般计算时会将计划内的停机排除掉

- 公有云一般99.95%

	- 数据量较大时，可以体会到公有云可用性没那么高
	- 3+log9(5)，大概3.3左右

### 为何要做高可用

- 读写分离，提升读的处理能力
- 故障转移，提供failover能力

	- failover 故障转移，灾难恢复

### 容灾

- 热备与冷备

	- stand by
	- 对于主从来说，简单讲就是主挂了，某一个从，变成主，

		- 从不干活，是冷备
		- 从干活，是热备

### 常见的策略

- 1、多个实例不在一个主机/机架上
- 2、跨机房和可用区部署
-  3、两地三中心容灾高可用方案

	- 金融行业：800公里，避免洪水
	- 银行要求：宕机时间不能超过40min分钟

### 高可用方案

- 方案1：主从手动切换

	- 用LVS+keepalived实现多个节点的探活+请求路由。配置VIP或DNS实现配置不变更

		- 问题

			- 1. 手工处理主从切换
			- 2. 大量的配置和脚本定义

- 方案2：MHA

	- Master High Availability
	- 全自动高可用
	- 基于Perl语言开发，一般能在30s内实现主从切换。 切换时，直接通过SSH复制主节点的日志。
	- 问题

		- 1. 需要配置SSH信息
		- 2. 至少3台

- 方案3：MGR

	- 如果主节点挂掉，将自动选择某个从改成主；
无需人工干预，基于组复制，保证数据一致性。
	- 问题

		- 1. 外部获得状态变更需要读取数据库。
		- 2. 外部需要使用LVS/VIP配置。

	- 
	- 
	- 适用场景

		- 弹性复制

			- 

		- 高可用分片

			- 

- 方案4：MySQL Cluster

	- 
	- 一整套技术解决方案
	- 

- 方案5：orchestrator

	- 
	- 基于Go语言开发，实现了中间件本身的高可用(?!)
	- 优势： 能直接在UI界面 拖拽改变主从关系
	- 

## 5、为何要做数据库拆分

### 为何一般推荐使用简单、尽量单表的SQL实现业务

- 方便日后扩展
- 必须使用复杂SQL时，推荐将这部分单独拿出来成为一个模块，这样数据库拆分后直接可以废弃、只修改其他需要保留的模块
- 单机数据库越来越大的时候可能导致的问题

	- 无法执行DDL

		- 数据库长时间不响应

	- 无法备份
	- 影响性能和稳定性

### 单机mysql的技术演进

- 

### 扩展立方体

- 
- X 轴：通过clone整个系统复制，集群
- Y 轴：通过解耦不同功能复制，业务拆分
- Z 轴：通过拆分不同数据扩展，数据分片

### 数据库/数据的扩展

- 

### 数据库垂直拆分

- 拆库

	- 将一个数据库，拆分成多个提供不同业务数据处理能力的数据库

- 拆表

### 数据库水平拆分

## 6、数据库垂直拆分

### 概念

- 拆库

	- 垂直拆分（拆库）：将一个数据库，拆分成多个提供不同业务数据处理能力的数据库。

- 拆表

	- 垂直拆分（拆表）：如果单表数据量过大，还可能需要对单表进行拆分。

- 优缺点

	- 

### 垂直拆分的一般做法

- 

### 案例分析

- 淘宝

	- 需求：

		- 买家CRUD
		- 卖家CRUD

	- 实现方案

		- 方案1

			- 只一套数据库，比如按照买家id进行分库分表，卖家的查询需要广播查询（成本会比较大）
			- 不推荐

		- 方案2：

			- 异构的数据库
			- 按买家ID进行分库分表，得到一套库，提供给买家使用
			- 同时按卖家ID也构建一套库，按卖家ID进行分库分表，提供给卖家相关服务使用
			- 淘宝就是这么干的
			- 如果有多个分库分表ID时，如果频率特别高，也可以使用这种异构方案

- 常见

	- 用户分库，订单分表
	- 或者分库、分表id正交

		- 比如：%2分库，%3分表
		- 否则将导致分库分表不均匀，起不到分库分表作用

## 7、数据库水平拆分

### 概念

- 分类

	- 分库
	- 分表
	- 分库分表
	- 

- 水平拆分（按主键分库分表）：水平拆分就是直接对数据进行分片，有分库和分表两个具体方 式，但是都只是降低单个节点数据量，但不改变数据本身的结构。这样对业务系统本身的代码 逻辑来说，就不需要做特别大的改动，甚至可以基于一些中间件做到透明。

### 分库分表方式

- 强制按条件指定分库分表：比如配置好某些用户的数据进入单独的库表，其他数据默认处理。
- 自定义方式分库分表：指定某些条件的数据进入到某些库或表。

### 思考题

- 为何有些DBA不建议分表，只建议分库？
一些中间件，也只支持分库，不能分表

	- 分库对业务透明
	- 子主题 2

### 分库还是分表，如何选择

- 一般情况下，如果数据本身的读写压力较大，磁盘 IO 已经成为瓶颈，那么分库比分表要好。
分库将数据分散到不同的数据库实例，使用不同的磁盘，从而可以并行提升整个集群的并行数据 处理能力。

相反的情况下，可以尽量多考虑分表，降低单表的数据量，从而减少单表操作的时 间，同时也能在单个数据库上使用并行操作多个表来增加处理能力。

### 优缺点

- 分库分表有什么优缺点： 
1、解决容量问题 
2、比垂直拆分对系统影响小 
3、部分提升性能和稳定性 

1、集群规模大，管理复杂 
2、复杂SQL支持问题（业务侵入性、性能） 
3、数据迁移问题 
4、一致性问题

## 8、数据的分类管理

### 以订单为例

- 热数据

	- 放到数据库和内存

- 温数据

	- 放到数据库，提供正常的查询操作

- 冷数据

	- 3年以上

- 冰数据

### 1、缘起

- 
- 

### 2、手段

- 

## 9、相关框架与中间件

### java框架层面

- 实例

	- shardingsphere-jdbc
	- TDDL（目前不开源）

- 优劣

	- 对业务代码有侵入
	- 只能对java

### proxy方案

- 实例

	- shardingsphere-proxy
	- MyCAT
	- DRDS（商业闭源）

		- 阿里云，目前比较成功
		- 实际上是一个中间件，但基本实现了mysql所有功能

	- Cobar

- 优劣

	- 对应用程序透明
	- 可以给任意框架使用

### 参考资料

- 
- https://www.cnblogs.com/aksir/p/9085694.html

### 数据库中间件的技术演进

- 分布式崛起

	- CAP理论

		- 

	- BASE理论

- 99还在java客户端方案
- 0.9用数据库中间件proxy
- 0。09用分布式数据库
- 原因

	- 决策需要更高层，需要长期维护
	- 引入分布式数据库的决策层级更高，需要DBA接入

- 
- 

## 10、如何做数据迁移

### 目标

- 数据准确，迁移速度快，减少停机，对业务影响小

	- 迁移是最容易出故障的一个点

### 迁移方式

- 全量数据的导出和导入

	- 步骤

		- 1、业务系统停机
		- 2、数据库迁移，校验一致性

			- 迁移时先删掉所有主键、索引，等导入完成后再重建，加速重建过程
			- 校验和
			- 数据处理

				- 直接复制

					- dump后全量导入

				- 如果是异构数据

					- 需要程序处理

		- 3、业务系统升级，接入新数据库

	- 优劣

		- 简单
		- 时间不可控，需停机，对线上业务影响较大

- 全量+增量

	- 依赖于数据本身的时间戳
	- 步骤

		- 1、先同步数据到最近的某个时间戳
		- 2、然后发布升级时停机维护
		- 3、再同步最后一段时间（通常是一天）的变化数据
		- 4、最后升级业务系统，接入新数据库

	- 优劣

		- 极大降低停机时间

- binlog +全量+增量

	- 通过主库或者从库的binlog来解析和重新构造数据，实现复制
	- 一般需要中间件等工具的支持

		- canal
		- otter

	- 可以实现多线程，断点续传，全量历史和增量数据同步。

### 迁移相关数据库中间件

- ShardingSphere

	- 

*XMind - Evaluation Version*

分库分表，听着多么高大上，做了很多年项目，也许都是传统的项目，数据量总是没那么大，加上数据的归档，还没真正涉及到分库分表，记得上一次面试问到这一块真的抓瞎懵逼，还需要实践学习。